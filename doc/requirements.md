# O社ブラウザバック広告ブロック拡張機能 要件定義書

## 1. 概要

### 1.1 背景
O社が提供するブラウザバック広告（「戻る」ボタンを押した際に表示される広告）は、ユーザーのブラウジング体験を妨げる要因となっている。特にImpressの運営するサイトなど多くのメディアサイトで採用されており、ユーザーにとって不快な体験となっている。この広告はHistory APIを悪用して、ブラウザの履歴を操作することで実現されている。

### 1.2 目的
本拡張機能は、O社が提供するブラウザバック広告を検出し、ブロックすることでユーザーのブラウジング体験を向上させることを目的とする。

### 1.3 対象ブラウザ
- Google Chrome

## 2. 機能要件

### 2.1 基本機能
1. **O社広告の検出**: History APIの操作を監視し、O社のブラウザバック広告の挿入を検出する
2. **広告のブロック**: 検出された広告の表示をブロックし、正常なブラウザバック機能を維持する
3. **オン/オフ切り替え**: ユーザーが拡張機能の有効/無効を簡単に切り替えられる機能

### 2.2 詳細機能

#### 2.2.1 History API監視機能
- ウェブページ内でのHistory API（history.pushState, history.replaceState）の呼び出しを監視
- O社の広告挿入パターンを検出するフィルタリングロジックの実装
- 不正なHistory操作が検出された場合のアクション定義

#### 2.2.2 広告ブロック機能
- O社広告のURLパターン（outbrain.comドメインからのリソース）を特定
- 特定されたリソースの読み込みをブロック
- ブラウザの履歴から不正に挿入された広告ページエントリを削除

#### 2.2.3 ユーザーインターフェース
- 拡張機能のオン/オフを切り替えるトグルボタン
- 現在の状態（有効/無効）を示すアイコン表示
- ブロック統計（ブロックした広告の数など）の表示（オプション）

## 3. 技術要件

### 3.1 開発言語・技術
- JavaScript
- HTML/CSS（ユーザーインターフェース用）
- Chrome Extension API

### 3.2 アクセス権限
- `webRequest`: ウェブリクエストの監視・ブロック
- `webRequestBlocking`: リクエストのブロック
- `history`: ブラウザ履歴の操作
- `tabs`: 現在のタブ情報へのアクセス
- `storage`: 設定の保存

### 3.3 主要コンポーネント
1. **Background Script**:
   - 拡張機能のメイン処理を担当
   - History APIの監視
   - ブロックロジックの実装

2. **Content Script**:
   - ウェブページ内のJavaScriptを監視
   - History API操作の検出

3. **Popup UI**:
   - 拡張機能の有効/無効切り替え
   - 統計情報の表示（オプション）

4. **Manifest.json**:
   - 拡張機能の基本設定
   - 必要な権限の定義

## 4. 実装方針

### 4.1 History API操作の検出
1. Content Scriptを使用して、ページ内でのHistory API（history.pushState, history.replaceState）の呼び出しをオーバーライド
2. O社関連のURLパターンまたは特定の操作パターンを検出
3. 不正な操作が検出された場合、Background Scriptに通知

### 4.2 広告ブロック方法
1. `webRequest` APIを使用して、O社広告のリソース読み込みをブロック
2. 以下のドメインからのリクエストを監視・ブロック:
   - outbrain.com
   - widgets.outbrain.com
   - vra.outbrain.com
   - vrp.outbrain.com
   - vrt.outbrain.com
   - mv.outbrain.com
   - その他O社関連ドメイン

### 4.3 ブラウザ履歴の修正
1. 不正に挿入された広告ページを検出した場合、`history` APIを使用して履歴から削除
2. ユーザーの意図した履歴遷移を保持

## 5. ユーザー体験

### 5.1 インストール後の動作
- デフォルトでは拡張機能は有効状態
- 特別な設定なしで即座にブラウザバック広告のブロックを開始
- ブロック動作はバックグラウンドで実行され、ユーザーに対して透過的

### 5.2 ユーザーインタラクション
- ブラウザツールバーの拡張機能アイコンをクリックで設定画面を開く
- シンプルなトグルスイッチで機能のオン/オフを切り替え
- オプションでブロック統計を表示（何件のO社広告がブロックされたか）

## 6. テスト計画

### 6.1 テスト環境
- 異なるバージョンのChrome
- Impressなど、O社広告が確認されているサイト

### 6.2 テストケース
1. 通常のブラウザバック操作でのブロック機能確認
2. 異なるサイトでのブロック効果検証
3. 拡張機能オン/オフ切り替え機能の確認
4. パフォーマンス影響の測定

## 7. 開発ロードマップ

### フェーズ1: 基本実装
- 基本的なHistory API監視機能の実装
- O社広告URLのブロック機能実装
- シンプルなUI実装

### フェーズ2: 機能強化
- ブロック精度の向上
- ブロック統計表示機能の追加
- ユーザーフィードバックに基づく改善

### フェーズ3: 拡張
- 他の類似広告（TaboolaなどOutbrain以外の広告プロバイダー）への対応
- パフォーマンス最適化

## 8. リスク分析

### 8.1 技術的リスク
- History APIの仕様変更による影響
- Outbrain側での広告表示方法の変更による対応必要性
- ブラウザアップデートによる互換性問題

### 8.2 ユーザー体験リスク
- 誤検出によるブラウザ履歴操作の不具合
- 過度のブロックによる正常なサイト機能への影響

## 9. 参考資料

1. 「ブラウザの履歴を操作して「戻る」ボタンで広告を出すやつについて」 - blog.maripo.org
2. History API - MDN Web Docs
3. Chrome Extensions API リファレンス